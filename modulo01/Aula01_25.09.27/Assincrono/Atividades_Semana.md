# üè† Atividades Ass√≠ncronas

## Parte 01 - Exerc√≠cios livres, recaptulando a aula

1. **Normalizar** a tabela PedidosProblematicos at√© 3FN

```sql
CREATE TABLE PedidosProblematicos (
    PedidoID INT,                   -- Deve pertencer a uma table com dados b√°sicos do pedido

    ClienteNome VARCHAR(100),       -- Deve pertencer a uma table "Clientes"
    ClienteEmail VARCHAR(100),      -- Deve pertencer a uma table "Clientes", talvez numa "sub-table" de contatos
    ClienteCidade VARCHAR(50),      -- Deve pertencer a uma table "Clientes", talvez numa "sub-table" de endere√ßos
    ClienteEstado VARCHAR(2),       -- Deve pertencer a uma table "Clientes", talvez numa "sub-table" de endere√ßos
    ClienteCEP VARCHAR(10),         -- Deve pertencer a uma table "Clientes", talvez numa "sub-table" de endere√ßos

    ProdutoNome VARCHAR(100),       -- Deve pertencer a uma table "Produtos"
    ProdutoCategoria VARCHAR(50),   -- Deve pertencer a uma table "Categorias"
    ProdutoPreco DECIMAL(10,2),     -- Deve pertencer a uma table "Produtos"

    Quantidade INT,                 -- Deve estar inserida na table dos dados do pedido
    DataPedido DATE,                -- Deve estar inserida na table dos dados do pedido

    TelefonesContato VARCHAR(200),  -- Deve pertencer a uma table "Clientes", talvez numa "sub-table" de contatos

    NomeVendedor VARCHAR(100),      -- Deve pertencer a um table "Vendedores"
    ComissaoVendedor DECIMAL(5,2),  -- Deve pertencer a um table "Vendedores", numa "sub-table" de comiss√µes por m√™s?

    EnderecoCompleto VARCHAR(300)   -- Acredito que deva ser apenas em uma view (?)
);
```

**RESPOSTA**
```sql
-- √ÅREA DE CLIENTE --
CREATE TABLE Clientes (
    ClienteID SERIAL PRIMARY KEY,

    PrimeiroNome TEXT NOT NULL,
    UltimoNome TEXT NOT NULL,
    DataNascimento DATE NOT NULL,
    Email TEXT NOT NULL UNIQUE, -- Pesquisar forma de validar modelo do insert, para que confirme ser um e-mail?!

    CreatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UpdatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE DocumentosCliente (
    DocumentoID SERIAL PRIMARY KEY,
    ClienteID INT NOT NULL REFERENCES Clientes(ClienteID) ON DELETE CASCADE, -- FK | "ON DELETE CASCADE", se apagar cliente, apaga documentos.

    DocTipo VARCHAR(3) NOT NULL CHECK (UPPER(DocTipo) IN ('CPF', 'RG')), -- Tipo controlado, 1 por linha
    NumDoc VARCHAR(11) NOT NULL, -- Fazer valida√ß√£o do tipo de documento para inputar o lenght correto

    UNIQUE (ClienteID, DocTipo), -- Garante 1 documento de cada por cliente
    UNIQUE (DocTipo, NumDoc) -- Impede que haja duplicidade de documente 

    -- Pesquisar e incluir check para length de cada documento
);

CREATE TABLE TelefonesCliente (
    TelefoneID SERIAL PRIMARY KEY,
    ClienteID INT NOT NULL REFERENCES Clientes(ClienteID) ON DELETE CASCADE, -- FK | "ON DELETE CASCADE", se apagar cliente, apaga telefones.

    NumTipo VARCHAR(20) NOT NULL CHECK (UPPER(NumTipo) IN ('CELULAR', 'RESIDENCIAL', 'COMERCIAL')), -- Tipo controlado, 1 por linha
    Numero VARCHAR(30) NOT NULL, -- para manter o padr√£o DDD/DDI, ou estilizar no front?

    UNIQUE (ClienteID, NumTipo, Numero) -- evita duplicar o mesmo n√∫mero/tipo no cliente

    -- Pesquisar e incluir check para o n√∫mero de telefone
);

CREATE TABLE TiposEndereco (
    Tipo VARCHAR(20) PRIMARY KEY -- flexibiliza√ß√£o para os tipos de endere√ßos. O pr√≥prio usu√°rio descreve?!
);

CREATE TABLE EnderecosCliente (
    EnderecoID SERIAL PRIMARY KEY,
    ClienteID INT NOT NULL REFERENCES Clientes(ClienteID) ON DELETE CASCADE, -- FK | "ON DELETE CASCADE", se apagar cliente, apaga telefones.

    EnderecoTipo VARCHAR(40) NOT NULL REFERENCES TiposEndereco(Tipo), -- FK | apanha o tipo na tabela de refer√™ncia

    EnderecoCEP VARCHAR(10) NOT NULL,
    EnderecoLogradouro TEXT NOT NULL,
    EnderecoNumero VARCHAR(10) NOT NULL,
    EnderecoComplemento VARCHAR(30),
    EnderecoBairro VARCHAR(60) NOT NULL,
    EnderecoCidade VARCHAR(60) NOT NULL,
    EnderecoEstado CHAR(2) NOT NULL,
    EnderecoPais VARCHAR(40) NOT NULL,

    CreatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UpdatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- √ÅREA LOJAS --
CREATE TABLE LojasFisicas (
    LojaID SERIAL PRIMARY KEY,

    NomeFantasia TEXT NOT NULL,
    RazaoSocial TEXT NOT NULL,
    CNPJ VARCHAR(14) NOT NULL UNIQUE, -- valida√ß√£o futura com CHECK (14 d√≠gitos)
    EmailContato TEXT,
    TelefoneContato VARCHAR(30),

    EnderecoID INT REFERENCES EnderecosCliente(EnderecoID), -- FK: podemos usar o mesmo modelo de endere√ßos
    Ativa BOOLEAN NOT NULL DEFAULT TRUE,

    CreatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UpdatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE TelefonesLoja (
    TelefoneID SERIAL PRIMARY KEY,
    LojaID INT NOT NULL REFERENCES LojasFisicas(LojaID) ON DELETE CASCADE, -- FK | "ON DELETE CASCADE", se apagar loja, apaga telefonesLoja.

    Numero VARCHAR(30) NOT NULL, -- para manter o padr√£o DDD/DDI, ou estilizar no front?

    UNIQUE (LojaID, Numero) -- evita duplicar o mesmo n√∫mero/tipo na loja

    -- Pesquisar e incluir check para o n√∫mero de telefone
);

-- √ÅREA VENDEDORES --
CREATE TABLE Vendedores (
    VendedorID SERIAL PRIMARY KEY,
    LojaID INT REFERENCES LojasFisicas(LojaID), -- Para indicar onde o vendedor est√° lotado e se √© apenas vendedor online

    Nome TEXT NOT NULL,
    Sobrenome TEXT NOT NULL,
    DataNascimento DATE NOT NULL,

    Email TEXT NOT NULL UNIQUE,
    Ativo BOOLEAN NOT NULL DEFAULT TRUE, -- se profissional ainda pertence √† empresa
    Cargo VARCHAR(20) NOT NULL CHECK (UPPER(Cargo) IN ('ASSISTENTE', 'SUPERVISOR', 'GERENTE')), -- cargo com lista

    CodVendedor VARCHAR(9) NOT NULL UNIQUE, -- c√≥d do vendedor, pode ser matr√≠cula que ser√° usada para compras online

    CreatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UpdatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE VendedoresLoja (
    VendedorID INT NOT NULL REFERENCES Vendedores(VendedorID),
    LojaID INT NOT NULL REFERENCES LojasFisicas(LojaID),

    DataInicio DATE NOT NULL,
    DataFim DATE,

    PRIMARY KEY (VendedorID, LojaID, DataInicio)
);

CREATE TABLE ComissoesVendedor (
    VendedorID INT NOT NULL REFERENCES Vendedores(VendedorID), -- FK
    PedidoID INT NOT NULL REFERENCES PedidosCliente(PedidoID), -- FK

    ValorPedido DECIMAL (10,2) NOT NULL CHECK (ValorPedido >= 0), -- Valor do pedido 
    PercentualAplicado DECIMAL(5,2) NOT NULL CHECK (PercentualAplicado >= 0), -- indica√ß√£o do percentual de comiss√£o aplicado
    ValorComissao DECIMAL (10,2) NOT NULL CHECK (ValorComissao >= 0), -- valor da comiss√£o j√° calculado

    TipoVenda VARCHAR(6) NOT NULL CHECK (UPPER(TipoVenda) IN ('LOJA', 'ONLINE')), -- rastreio do canal de venda

    RegistradoEm TIMESTAMPTZ NOT NULL DEFAULT NOW(), -- para acompanhamento de quando foi efetivado o registro da comiss√£o (casos de devolu√ß√£o online)
    
    PRIMARY KEY (VendedorID, PedidoID) -- chave composta, 1 linha por vendedor<>pedido
);

-- √ÅREA DE PRODUTOS --
CREATE TABLE CategoriasProdutos (
    CategoriaID SERIAL PRIMARY KEY,
    NomeCategoria VARCHAR (50) UNIQUE NOT NULL,

    CreatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UpdatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE Produtos (
    ProdutoID SERIAL PRIMARY KEY,
    CategoriaID INT REFERENCES CategoriasProdutos(CategoriaID) NOT NULL, -- FK, obrigat√≥ria

    Nome VARCHAR(50) NOT NULL,
    Marca VARCHAR(50) NOT NULL,
    Modelo VARCHAR(50) NOT NULL,
    UNIQUE (Marca, Modelo),
    
    NumSerie VARCHAR(100) UNIQUE,
    
    PrecoAtual NUMERIC(10,2) CHECK (PrecoAtual >= 0) NOT NULL,
    
    Estoque INTEGER CHECK (Estoque >= 0) DEFAULT 0,

    CreatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UpdatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- √ÅREA DE PEDIDOS --
CREATE TABLE PedidosCliente (
    PedidoID SERIAL PRIMARY KEY,
    ClienteID INT NOT NULL REFERENCES Clientes(ClienteID), -- FK
    EnderecoEntregaID INT NOT NULL REFERENCES EnderecosCliente(EnderecoID), -- FK
    
    VendedorID INT REFERENCES Vendedores(VendedorID) ON DELETE SET NULL, -- FK | permite inativar vendedor
    
    DataPedido DATE NOT NULL,

    CreatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UpdatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE ItensPedido (
    PedidoID INT NOT NULL REFERENCES PedidosCliente(PedidoID) ON DELETE CASCADE, -- FK | apaga pedido, apaga itens do pedido
    ProdutoID INT NOT NULL REFERENCES Produtos(ProdutoID),
    Quantidade INT NOT NULL CHECK (Quantidade > 0),
    PrecoUnitario DECIMAL(10,2) NOT NULL, -- Um "snapshot" do pre√ßo atual, pago pelo cliente. 
    PRIMARY KEY (PedidoID, ProdutoID)
);
```

2. **Criar um modelo desnormalizado da tabela do exerc√≠cio 1** para relat√≥rios e justifique quando usar

3. **Ler cap√≠tulo sobre Views** no PostgreSQL Docs

## üìò Lista de Exerc√≠cios ‚Äì SQL com Dataset `juliaostore.sql`

## üìå Parte 1 ‚Äì Consultas B√°sicas
1. **Liste todos os clientes cadastrados.**
   üí° *Dica: SELECT simples na tabela Clientes*

2. **Liste todos os produtos da categoria "Acess√≥rios".**
   üí° *Dica: WHERE com filtro de categoria*

3. **Mostre todos os pedidos feitos por Ana Silva.**
   üí° *Dica: JOIN entre Clientes e Pedidos + filtro no nome*

---

## üìå Parte 2 ‚Äì Consultas Intermedi√°rias

4. **Exiba o valor total de cada pedido.**
   üí° *Dica: Preciso multiplicar quantidade √ó pre√ßo, depois somar por pedido*
   ü§î *Quais tabelas conectar? Pedidos ‚Üí ItensPedido ‚Üí Produtos*

5. **Traga o total gasto por cada cliente.**
   üí° *Dica: Expandir a consulta anterior agrupando por cliente*

6. **Mostre os produtos mais vendidos em quantidade.**
   üí° *Dica: SUM(Quantidade) GROUP BY Produto + ORDER BY DESC*

---

## üìå Parte 3 ‚Äì Consultas Avan√ßadas

7. **Liste os clientes que j√° compraram mais de um tipo diferente de produto.**
   üí° *Dica: COUNT(DISTINCT ProdutoID) > 1*

8. **Mostre os pedidos cujo valor total foi acima de R$ 3000.**
   üí° *Dica: Use a consulta do exerc√≠cio 4 + HAVING*

9. **Calcule o ticket m√©dio dos clientes (m√©dia de valor gasto por pedido).**
   üí° *Dica: AVG() da soma dos subtotais*

10. **Liste os clientes que nunca fizeram pedidos.**
    üí° *Dica: LEFT JOIN + WHERE campo IS NULL*

---

## üéØ Desafios Extras (Para os Ninjas!)

11. **Qual produto gerou mais receita total?**
12. **Quantos clientes compraram em setembro de 2025?**
13. **Qual a diferen√ßa entre o maior e menor ticket de pedido?**